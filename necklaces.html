<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Necklaces | SKJ Jewelleries</title>
    <link rel="icon" type="image/png" href="./images/Screenshot_12-2-2026_195823_localhost.jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --royal-green: #004d40; --gold: #D4AF37; }
        
        /* Copy ALL styles from rings.html exactly */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        @media (max-width: 640px) { .products-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; } }
        
        .product-card { background: white; border-radius: 1rem; overflow: hidden; border: 2px solid #e5e7eb; transition: all 0.3s ease; position: relative; display: flex; flex-direction: column; }
        
        @media (min-width: 1024px) {
            .product-card { border: 3px solid transparent; }
            .product-card:hover { border-color: var(--gold); box-shadow: 0 15px 30px rgba(212, 175, 55, 0.2); transform: translateY(-4px); }
        }
        
        .product-card.out-of-stock { opacity: 0.6; }
        
        .out-of-stock-btn {
            width: 100%; 
            background: #9ca3af; 
            color: white; 
            border: none; 
            padding: 0.5rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            font-size: 0.75rem; 
            cursor: not-allowed; 
            margin-top: auto; 
            text-transform: uppercase;
        }
        
        /* Product Image Gallery */
        .product-image-gallery {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        
        .product-image-main {
            position: relative;
            height: 220px;
            overflow: hidden;
            background: #f9f9f9;
            flex-shrink: 0;
        }
        @media (max-width: 640px) { .product-image-main { height: 160px; } }
        
        .product-image-main img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
            cursor: pointer;
        }
        
        @media (min-width: 1024px) {
            .product-card:hover .product-image-main img { transform: scale(1.05); }
        }
        
        .product-image-thumbnails {
            display: grid;
            gap: 0.25rem;
            min-height: 50px;
            flex-shrink: 0;
        }
        
        .thumbnails-grid-4 { grid-template-columns: repeat(4, 1fr); }
        .thumbnails-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .thumbnails-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .thumbnails-grid-1 { grid-template-columns: 1fr; max-width: 60px; margin: 0 auto; }
        .thumbnails-grid-0 { display: none; }
        
        .product-image-thumbnail {
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 0.35rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        @media (min-width: 1024px) {
            .product-image-thumbnail:hover { border-color: var(--gold); }
        }
        
        .product-image-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        
        @media (min-width: 1024px) {
            .product-image-thumbnail:hover img { transform: scale(1.1); }
        }
        
        .discount-badge { 
            position: absolute; 
            top: 8px; 
            left: 8px; 
            background: #ef4444; 
            color: white; 
            padding: 3px 8px; 
            border-radius: 999px; 
            font-size: 10px; 
            font-weight: 700; 
            z-index: 10; 
            display: none;
        }
        
        .discount-badge.show { display: block; }
        
        .wishlist-btn { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            width: 28px; 
            height: 28px; 
            background: rgba(255,255,255,0.85); 
            border: 2px solid #e5e7eb; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.3s; 
            z-index: 10; 
        }
        
        @media (min-width: 1024px) {
            .wishlist-btn { border: none; }
            .wishlist-btn:hover { transform: scale(1.15); background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        }
        
        .wishlist-btn i { font-size: 0.8rem; }
        .wishlist-btn.active i { color: #ef4444; }
        
        .product-info { 
            padding: 0.75rem; 
            display: flex;
            flex-direction: column;
            flex: 1;
            justify-content: flex-end;
        }
        @media (max-width: 640px) { .product-info { padding: 0.5rem; } }
        
        .product-name { font-weight: 700; color: #1f2937; margin-bottom: 0.2rem; font-size: 0.85rem; line-height: 1.2; }
        @media (max-width: 640px) { .product-name { font-size: 0.75rem; } }
        
        .product-price { display: flex; align-items: baseline; gap: 0.35rem; margin-bottom: 0.5rem; min-height: 1.5rem; }
        .original-price { color: #9ca3af; text-decoration: line-through; font-size: 0.7rem; }
        @media (max-width: 640px) { .original-price { font-size: 0.65rem; } }
        .offer-price { color: var(--gold); font-weight: 800; font-size: 0.9rem; }
        @media (max-width: 640px) { .offer-price { font-size: 0.8rem; } }
        
        .single-price {
            color: var(--gold);
            font-weight: 800;
            font-size: 0.9rem;
        }
        
        .add-to-cart-btn { 
            width: 100%; 
            background: var(--royal-green); 
            color: white; 
            border: none; 
            padding: 0.5rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            font-size: 0.75rem; 
            cursor: pointer; 
            transition: all 0.3s; 
            text-transform: uppercase; 
            position: relative;
            overflow: hidden;
        }
        
        .add-to-cart-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .add-to-cart-btn:active::after {
            width: 300px;
            height: 300px;
        }
        
        .add-to-cart-btn.added {
            background: #10b981 !important;
        }
        
        @media (min-width: 1024px) {
            .add-to-cart-btn:hover { background: #00332b; }
        }
        
        .qty-control { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: #f3f4f6; 
            border-radius: 0.5rem; 
            padding: 0.2rem; 
            margin-top: auto; 
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .qty-btn { 
            width: 28px; 
            height: 28px; 
            background: var(--royal-green); 
            color: white; 
            border: none; 
            border-radius: 0.35rem; 
            font-weight: 700; 
            cursor: pointer; 
            font-size: 0.8rem; 
        }
        .qty-display { 
            font-weight: 700; 
            color: var(--royal-green); 
            min-width: 24px; 
            text-align: center; 
            font-size: 0.8rem; 
        }
        
        /* Popup styles - copy from rings.html */
        .product-popup { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.85); 
            z-index: 9500; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem; 
            backdrop-filter: blur(4px); 
        }
        .product-popup.active { display: flex; }
        
        .popup-content { 
            background: white; 
            border-radius: 1.5rem; 
            max-width: 900px; 
            width: 90vw; 
            max-height: 85vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            position: relative;
            margin: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        @media (min-width: 768px) { 
            .popup-content { 
                flex-direction: row; 
                width: 85vw;
            } 
        }
        
        @media (max-width: 767px) {
            .popup-content {
                width: 95vw;
                max-height: 90vh;
                border-radius: 1rem;
            }
        }
        
        .popup-image-section { 
            position: relative; 
            height: 350px; 
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) { 
            .popup-image-section { 
                flex: 0 0 45%; 
                height: auto;
                min-height: 450px;
            } 
        }
        
        .popup-image-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .popup-main-img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            cursor: zoom-in;
            transition: all 0.3s ease;
        }
        
        .popup-zoom-controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 20;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid var(--gold);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--gold);
            transition: all 0.3s;
        }
        
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            z-index: 12;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .carousel-btn.prev { left: 0.75rem; }
        .carousel-btn.next { right: 0.75rem; }
        
        .popup-details {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .popup-details {
                padding: 2rem;
            }
        }
        
        .close-popup {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .popup-title {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--royal-green);
            margin-bottom: 0.75rem;
            font-family: 'Cinzel', serif;
        }
        
        .popup-specs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            padding: 0.875rem;
            background: #f9f9f9;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }
        
        .popup-specs-label {
            color: #6b7280;
            font-size: 0.8rem;
            margin-bottom: 0.125rem;
        }
        
        .popup-specs-value {
            color: var(--royal-green);
            font-weight: 600;
        }
        
        .popup-price-section {
            margin-bottom: 1rem;
        }
        
        .popup-original-price {
            color: #9ca3af;
            text-decoration: line-through;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .popup-original-price.hidden {
            display: none;
        }
        
        .popup-offer-price {
            font-size: 1.75rem;
            font-weight: 900;
            color: var(--gold);
        }
        
        .popup-add-to-cart {
            width: 100%;
            background: var(--royal-green);
            color: white;
            border: none;
            padding: 0.875rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: auto;
        }
        
        .popup-add-to-cart:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .popup-qty-control {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f3f4f6;
            border-radius: 0.75rem;
            padding: 0.375rem;
            margin-top: auto;
        }
        
        .popup-qty-btn {
            width: 40px;
            height: 40px;
            background: var(--royal-green);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 700;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .popup-qty-display {
            font-weight: 700;
            color: var(--royal-green);
            font-size: 1rem;
            min-width: 40px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="header-placeholder"></div>
    <div id="cta-placeholder"></div>

    <main class="main-content">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="text-center mb-8 mt-8 lg:mt-12">
                <h1 class="text-3xl md:text-4xl font-bold text-emerald-950 uppercase tracking-wider mb-2">Necklaces Collection</h1>
                <p class="text-gray-600">Elegant necklaces for every occasion</p>
            </div>
            
            <div class="products-grid" id="products-container"></div>
        </div>
        
        <div id="footer-placeholder"></div>
    </main>

    <div id="mobile-nav-placeholder"></div>

    <!-- Product Popup -->
    <div id="product-popup" class="product-popup">
        <div class="popup-content relative">
            <button class="close-popup" onclick="closePopup()">&times;</button>
            
            <div class="popup-image-section">
                <div class="popup-badge" id="popup-discount"></div>
                <button onclick="event.stopPropagation(); togglePopupWishlist()" class="popup-heart-btn" id="popup-heart-btn">
                    <i class="fa-regular fa-heart"></i>
                </button>
                
                <div class="popup-image-container">
                    <img id="popup-main-img" src="" alt="Product" class="popup-main-img">
                    <button onclick="changePopupImg(-1)" class="carousel-btn prev">❮</button>
                    <button onclick="changePopupImg(1)" class="carousel-btn next">❯</button>
                </div>
                
                <div class="popup-zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()" id="zoom-in-btn" title="Zoom In">+</button>
                    <button class="zoom-btn" onclick="zoomOut()" id="zoom-out-btn" title="Zoom Out" disabled>−</button>
                </div>
            </div>
            
            <div class="popup-details">
                <h2 id="popup-title" class="popup-title"></h2>
                
                <div class="popup-specs">
                    <div>
                        <div class="popup-specs-label">Purity</div>
                        <div class="popup-specs-value">22K / 916 Hallmark</div>
                    </div>
                    <div>
                        <div class="popup-specs-label">Gross Weight</div>
                        <div class="popup-specs-value" id="popup-weight"></div>
                    </div>
                </div>
                
                <div class="popup-price-section">
                    <div class="popup-original-price" id="popup-original"></div>
                    <div class="popup-offer-price" id="popup-price"></div>
                </div>
                
                <div id="popup-actions"></div>
            </div>
        </div>
    </div>

        <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="fixed top-0 right-0 w-full max-w-md h-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[9000] flex flex-col">
        <div class="flex justify-between items-center p-6 border-b">
            <h3 class="text-xl font-bold text-emerald-950">Shopping Bag</h3>
            <button onclick="toggleCart()" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto p-6">
            <p class="text-center text-gray-400 mt-10">Your bag is empty</p>
        </div>
        <div class="border-t p-6 bg-gray-50">
            <div class="flex justify-between text-lg font-bold mb-4">
                <span>Total:</span>
                <span id="cart-total">₹0</span>
            </div>
            <button onclick="openOrderPopup()" class="w-full bg-emerald-950 text-white py-3 rounded-lg font-bold hover:bg-emerald-800 transition">Order Now</button>
        </div>
    </div>

    <!-- Login Panel (same as components.js loginPanel) -->
    <div id="login-panel-overlay" class="fixed inset-0 bg-black/50 z-[8999] hidden" onclick="toggleLoginPanel()"></div>
    <div id="login-panel" class="fixed top-0 right-0 w-full max-w-md h-full bg-white shadow-2xl z-[9000] transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="bg-emerald-950 text-white p-6 flex justify-between items-center">
            <h3 class="text-xl font-bold" id="login-panel-title">Sign In</h3>
            <button onclick="toggleLoginPanel()" class="text-2xl hover:text-amber-400 transition">&times;</button>
        </div>
        <div id="login-panel-form" class="flex-1 overflow-y-auto p-6">
            <div class="mb-6">
                <p class="text-gray-600 mb-4">Welcome back! Please sign in to continue.</p>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input type="email" id="panel-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-emerald-950" placeholder="Enter your email">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="panel-password" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-emerald-950" placeholder="Enter your password">
                </div>
                <div id="login-panel-error" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
                <button onclick="panelLogin()" class="w-full bg-emerald-950 text-white py-3 rounded-lg font-semibold hover:bg-emerald-800 transition">Sign In</button>
            </div>
            <div class="text-center">
                <a href="register.html" class="text-emerald-700 hover:underline">Create Account</a>
            </div>
        </div>
        <div id="login-panel-user" class="hidden flex-1 overflow-y-auto p-6">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user text-3xl text-emerald-700"></i>
                </div>
                <h4 class="text-lg font-bold text-gray-800" id="panel-user-name">User</h4>
                <p class="text-sm text-gray-500" id="panel-user-email">user@email.com</p>
            </div>
            <div class="space-y-3">
                <button onclick="panelLogout()" class="w-full text-left p-4 bg-red-50 rounded-lg hover:bg-red-100 transition flex items-center gap-3 text-red-700">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        try {
            import('./firebase-config.js').then(module => {
                if (module.db) {
                    window.db = module.db;
                    console.log('✅ Firebase initialized');
                    loadProductsFromFirebase();
                } else {
                    generateFallbackProducts();
                }
            }).catch(err => {
                console.log('⚠️ Firebase config not found');
                generateFallbackProducts();
            });
        } catch (e) {
            generateFallbackProducts();
        }
    </script>
    
    <script src="components.js"></script>
    <script>
        // Copy ALL JavaScript from rings.html, changing only the category filter
        let firebaseProducts = [];
        let productImages = {};
        let productImageOrders = {};
        let currentPopupId = '';
        let currentImageIndex = 0;
        let zoomLevel = 1;
        let productsUnsubscribe = null;
        
        let touchStartX = 0, touchStartY = 0, dragStartX = 0, dragStartY = 0;
        let isDragging = false, imageOffsetX = 0, imageOffsetY = 0;
        
        async function loadProductsFromFirebase() {
            try {
                const { collection, query, where, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
                
                if (productsUnsubscribe) productsUnsubscribe();
                
                const productsRef = collection(window.db, 'products');
                const q = query(
                    productsRef, 
                    where('category', '==', 'necklaces'),
                    where('isActive', '==', true),
                    where('onlineEnabled', '==', true)
                );
                
                productsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    firebaseProducts = [];
                    querySnapshot.forEach((doc) => {
                        firebaseProducts.push({ id: doc.id, ...doc.data() });
                    });
                    renderInventoryProducts();
                }, (error) => {
                    console.error('Error:', error);
                    generateFallbackProducts();
                });
                
            } catch (error) {
                generateFallbackProducts();
            }
        }
        
        function getThumbnailGridClass(thumbnailCount) {
            if (thumbnailCount >= 4) return 'thumbnails-grid-4';
            if (thumbnailCount === 3) return 'thumbnails-grid-3';
            if (thumbnailCount === 2) return 'thumbnails-grid-2';
            if (thumbnailCount === 1) return 'thumbnails-grid-1';
            return 'thumbnails-grid-0';
        }
        
        function renderInventoryProducts() {
            const container = document.getElementById('products-container');
            const params = new URLSearchParams(window.location.search);
            const searchQuery = (params.get('q') || '').toLowerCase().trim();
            
            let html = '';
            
            firebaseProducts.forEach((product, index) => {
                if (searchQuery && !product.name.toLowerCase().includes(searchQuery)) return;
                
                const discount = product.discountPercent || 0;
                const weight = product.weight || (Math.random() * 20 + 10).toFixed(2);
                const offerPrice = product.offerPrice || product.price || 0;
                const originalPrice = product.originalPrice || offerPrice;
                const hasDiscount = originalPrice > offerPrice && discount > 0;
                
                const images = product.images && product.images.length > 0 
                    ? [...product.images] 
                    : Array.from({length: 5}, (_, i) => `https://picsum.photos/id/${index + 100 + i}/400/400`);
                
                if (!productImageOrders[product.id]) {
                    productImageOrders[product.id] = [...images];
                }
                const currentImages = productImageOrders[product.id];
                
                productImages[product.id] = currentImages;
                
                const thumbnails = currentImages.slice(1);
                const thumbnailCount = thumbnails.length;
                const gridClass = getThumbnailGridClass(thumbnailCount);
                
                const isWishlisted = wishlist.some(w => w.id === product.id);
                const inCart = cart[product.id]?.qty || 0;
                const isOutOfStock = !product.inStock;
                
                let priceHtml = '';
                if (hasDiscount) {
                    priceHtml = `<span class="original-price">₹${originalPrice.toLocaleString()}</span><span class="offer-price">₹${offerPrice.toLocaleString()}</span>`;
                } else {
                    priceHtml = `<span class="single-price">₹${originalPrice.toLocaleString()}</span>`;
                }
                
                let buttonHtml = '';
                if (isOutOfStock) {
                    buttonHtml = `<button class="out-of-stock-btn" disabled>Out of Stock</button>`;
                } else if (inCart > 0) {
                    buttonHtml = `<div class="qty-control"><button class="qty-btn" onclick="event.stopPropagation(); updateCartItem('${product.id}', -1)">-</button><span class="qty-display">${inCart}</span><button class="qty-btn" onclick="event.stopPropagation(); updateCartItem('${product.id}', 1)">+</button></div>`;
                } else {
                    buttonHtml = `<button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCartWithFeedback('${product.id}', '${product.name}', ${offerPrice})">Add to Cart</button>`;
                }
                
                const discountBadgeClass = hasDiscount ? 'show' : '';
                
                html += `
                    <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" data-product-id="${product.id}" onclick="${isOutOfStock ? '' : `openPopup('${product.id}', ${offerPrice}, ${originalPrice}, ${discount}, '${weight}', ${isOutOfStock})`}">
                        <div class="product-image-gallery">
                            <div class="product-image-main">
                                <div class="discount-badge ${discountBadgeClass}">${discount}% OFF</div>
                                <button onclick="event.stopPropagation(); toggleWishlistWithButton('${product.id}', '${product.name}', this)" class="wishlist-btn ${isWishlisted ? 'active' : ''}">
                                    <i class="${isWishlisted ? 'fa-solid text-red-500' : 'fa-regular text-gray-600'} fa-heart"></i>
                                </button>
                                <img src="${currentImages[0]}" alt="${product.name}" loading="lazy" class="main-product-img">
                            </div>
                            <div class="product-image-thumbnails ${gridClass}">
                                ${thumbnails.map((img, idx) => `
                                    <div class="product-image-thumbnail" onclick="event.stopPropagation(); swapCardImage('${product.id}', ${idx})">
                                        <img src="${img}" alt="${product.name} image ${idx + 2}" loading="lazy">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="product-info">
                            <h3 class="product-name">${product.name}</h3>
                            <div class="product-price">${priceHtml}</div>
                            ${buttonHtml}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-center text-gray-500 col-span-full py-8">No necklaces found in inventory</p>';
        }
        
        function swapCardImage(productId, thumbnailIndex) {
            const currentImages = productImageOrders[productId];
            if (!currentImages || thumbnailIndex + 1 >= currentImages.length) return;
            
            const newImages = [...currentImages];
            const mainImageIndex = 0;
            const clickedImageIndex = thumbnailIndex + 1;
            
            [newImages[mainImageIndex], newImages[clickedImageIndex]] = [newImages[clickedImageIndex], newImages[mainImageIndex]];
            
            productImageOrders[productId] = newImages;
            
            const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
            if (card) {
                const mainImg = card.querySelector('.product-image-main img.main-product-img');
                const thumbnailImgs = card.querySelectorAll('.product-image-thumbnail img');
                
                mainImg.src = newImages[0];
                thumbnailImgs.forEach((thumb, idx) => {
                    if (idx + 1 < newImages.length) {
                        thumb.src = newImages[idx + 1];
                    }
                });
            }
        }
        
        function generateFallbackProducts() {
            const container = document.getElementById('products-container');
            container.innerHTML = '<p class="text-center text-gray-500 col-span-full py-8">Loading necklaces...</p>';
        }
        
        function toggleWishlistWithButton(id, name, btn) {
            const isActive = btn.classList.contains('active');
            const icon = btn.querySelector('i');
            const product = firebaseProducts.find(p => p.id === id);

            if (isActive) {
                wishlist = wishlist.filter(w => w.id !== id);
                btn.classList.remove('active');
                icon.classList.remove('fa-solid', 'text-red-500');
                icon.classList.add('fa-regular', 'text-gray-600');
            } else {
                const wishlistItem = product ? {
                    id: product.id, name: product.name, images: product.images || productImages[id] || [],
                    price: product.offerPrice || product.price || 0, offerPrice: product.offerPrice || product.price || 0,
                    originalPrice: product.originalPrice || product.offerPrice || product.price || 0,
                    weight: product.weight || '0', discountPercent: product.discountPercent || 0,
                    inStock: product.inStock !== false, category: product.category || 'necklaces'
                } : { id: id, name: name, images: productImages[id] || [], price: 0, offerPrice: 0, originalPrice: 0, weight: '0', discountPercent: 0, inStock: true, category: 'necklaces' };
                
                wishlist.push(wishlistItem);
                btn.classList.add('active');
                icon.classList.remove('fa-regular', 'text-gray-600');
                icon.classList.add('fa-solid', 'text-red-500');
            }

            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            updateWishlistUI();
        }

        function addToCartWithFeedback(id, name, price) {
            const btn = event.target;
            const currentQty = cart[id]?.qty || 0;
            const newQty = currentQty + 1;
            
            cart[id] = { qty: newQty, n: name, p: price };
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
            
            btn.classList.add('added');
            btn.innerText = 'Added!';
            
            setTimeout(() => {
                btn.classList.remove('added');
                renderInventoryProducts();
            }, 800);
        }

        function updateCartItem(id, delta) {
            const currentQty = cart[id]?.qty || 0;
            const newQty = currentQty + delta;
            
            if (newQty <= 0) {
                delete cart[id];
            } else {
                const product = firebaseProducts.find(p => p.id === id);
                const price = product ? (product.offerPrice || product.price || 0) : 0;
                const name = product ? product.name : `Product #${id}`;
                cart[id] = { qty: newQty, n: name, p: price || cart[id]?.p || 0 };
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
            renderInventoryProducts();
        }
        
        function handleTouchStart(e) {
            if (zoomLevel > 1) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }
        }
        
        function handleTouchMove(e) {
            if (zoomLevel > 1 && e.touches.length === 1) {
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                const deltaX = touchX - touchStartX;
                const deltaY = touchY - touchStartY;
                
                const img = document.getElementById('popup-main-img');
                if (img) {
                    imageOffsetX += deltaX * 0.5;
                    imageOffsetY += deltaY * 0.5;
                    const maxOffset = 100 * (zoomLevel - 1) / 3;
                    imageOffsetX = Math.max(-maxOffset, Math.min(maxOffset, imageOffsetX));
                    imageOffsetY = Math.max(-maxOffset, Math.min(maxOffset, imageOffsetY));
                    img.style.transform = `scale(${zoomLevel}) translate(${imageOffsetX / zoomLevel}px, ${imageOffsetY / zoomLevel}px)`;
                }
                touchStartX = touchX;
                touchStartY = touchY;
                e.preventDefault();
            }
        }
        
        function handleTouchEnd() {}
        
        function handleMouseDown(e) {
            if (zoomLevel > 1) {
                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                const img = document.getElementById('popup-main-img');
                if (img) img.style.cursor = 'grabbing';
            }
        }
        
        function handleMouseMove(e) {
            if (isDragging && zoomLevel > 1) {
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                const img = document.getElementById('popup-main-img');
                if (img) {
                    imageOffsetX += deltaX * 0.5;
                    imageOffsetY += deltaY * 0.5;
                    const maxOffset = 100 * (zoomLevel - 1) / 3;
                    imageOffsetX = Math.max(-maxOffset, Math.min(maxOffset, imageOffsetX));
                    imageOffsetY = Math.max(-maxOffset, Math.min(maxOffset, imageOffsetY));
                    img.style.transform = `scale(${zoomLevel}) translate(${imageOffsetX / zoomLevel}px, ${imageOffsetY / zoomLevel}px)`;
                }
                dragStartX = e.clientX;
                dragStartY = e.clientY;
            }
        }
        
        function handleMouseUp() {
            isDragging = false;
            const img = document.getElementById('popup-main-img');
            if (img) img.style.cursor = 'grab';
        }
        
        function resetImageOffset() {
            imageOffsetX = 0;
            imageOffsetY = 0;
        }

        function openPopup(id, price, original, discount, weight, isOutOfStock = false) {
            currentPopupId = id;
            currentImageIndex = 0;
            zoomLevel = 1;
            
            const product = firebaseProducts.find(p => p.id === id);
            const productName = product ? product.name : `Product #${id}`;
            
            document.getElementById('popup-title').innerText = productName;
            document.getElementById('popup-weight').innerText = `~${weight} Grams`;
            
            const hasDiscount = original > price && discount > 0;
            const popupOriginal = document.getElementById('popup-original');
            const popupPrice = document.getElementById('popup-price');
            const popupDiscount = document.getElementById('popup-discount');
            
            if (hasDiscount) {
                popupOriginal.innerText = `₹${original.toLocaleString()}`;
                popupOriginal.classList.remove('hidden');
                popupPrice.innerText = `₹${price.toLocaleString()}`;
                popupDiscount.innerText = `${discount}% OFF`;
                popupDiscount.classList.add('show');
            } else {
                popupOriginal.classList.add('hidden');
                popupPrice.innerText = `₹${original.toLocaleString()}`;
                popupDiscount.classList.remove('show');
            }
            
            const currentImages = productImageOrders[id] || productImages[id] || [];
            if (currentImages.length > 0) {
                document.getElementById('popup-main-img').src = currentImages[0];
            }
            
            updatePopupImage();
            
            const img = document.getElementById('popup-main-img');
            if (img) {
                img.addEventListener('touchstart', handleTouchStart);
                img.addEventListener('touchmove', handleTouchMove);
                img.addEventListener('touchend', handleTouchEnd);
                img.addEventListener('mousedown', handleMouseDown);
                img.style.cursor = 'grab';
            }
            
            resetImageOffset();
            
            const isWishlisted = wishlist.some(w => w.id === id);
            const heartBtn = document.getElementById('popup-heart-btn');
            const heartIcon = heartBtn.querySelector('i');
            if (isWishlisted) {
                heartBtn.classList.add('active');
                heartIcon.classList.remove('fa-regular');
                heartIcon.classList.add('fa-solid');
                heartIcon.style.color = '#ef4444';
            } else {
                heartBtn.classList.remove('active');
                heartIcon.classList.add('fa-regular');
                heartIcon.classList.remove('fa-solid');
                heartIcon.style.color = '#9ca3af';
            }
            
            const inCart = cart[id]?.qty || 0;
            const actionsDiv = document.getElementById('popup-actions');
            
            if (isOutOfStock) {
                actionsDiv.innerHTML = `<button class="popup-add-to-cart" disabled>Out of Stock</button>`;
            } else if (inCart > 0) {
                actionsDiv.innerHTML = `<div class="popup-qty-control"><button class="popup-qty-btn" onclick="updateCartItem('${id}', -1); refreshPopup(false)">−</button><span class="popup-qty-display">${inCart}</span><button class="popup-qty-btn" onclick="updateCartItem('${id}', 1); refreshPopup(false)">+</button></div>`;
            } else {
                actionsDiv.innerHTML = `<button class="popup-add-to-cart" onclick="addToCartWithFeedback('${id}', '${productName}', ${price}); refreshPopup(false)">Add to Cart</button>`;
            }
            
            document.getElementById('product-popup').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function updatePopupImage() {
            const currentImages = productImageOrders[currentPopupId] || productImages[currentPopupId] || [];
            if (!currentImages.length) return;
            const img = document.getElementById('popup-main-img');
            img.src = currentImages[currentImageIndex];
            img.style.transform = `scale(${zoomLevel}) translate(${imageOffsetX / zoomLevel}px, ${imageOffsetY / zoomLevel}px)`;
            img.classList.remove('zoomed');
        }

        function changePopupImg(direction) {
            const currentImages = productImageOrders[currentPopupId] || productImages[currentPopupId] || [];
            if (!currentImages.length) return;
            currentImageIndex = (currentImageIndex + direction + currentImages.length) % currentImages.length;
            zoomLevel = 1;
            resetImageOffset();
            updatePopupImage();
            updateZoomButtons();
        }

        function zoomIn() {
            if (zoomLevel < 4) {
                zoomLevel += 1;
                const img = document.getElementById('popup-main-img');
                img.style.transform = `scale(${zoomLevel}) translate(${imageOffsetX / zoomLevel}px, ${imageOffsetY / zoomLevel}px)`;
                img.classList.add('zoomed');
                img.style.cursor = 'grab';
                updateZoomButtons();
            }
        }

        function zoomOut() {
            if (zoomLevel > 1) {
                zoomLevel -= 1;
                const img = document.getElementById('popup-main-img');
                img.style.transform = `scale(${zoomLevel}) translate(${imageOffsetX / zoomLevel}px, ${imageOffsetY / zoomLevel}px)`;
                if (zoomLevel === 1) {
                    img.classList.remove('zoomed');
                    resetImageOffset();
                    img.style.cursor = 'default';
                }
                updateZoomButtons();
            }
        }

        function updateZoomButtons() {
            document.getElementById('zoom-in-btn').disabled = zoomLevel >= 4;
            document.getElementById('zoom-out-btn').disabled = zoomLevel <= 1;
        }

        function togglePopupWishlist() {
            const heartBtn = document.getElementById('popup-heart-btn');
            const name = document.getElementById('popup-title').innerText;
            const product = firebaseProducts.find(p => p.id === currentPopupId);
            const isActive = heartBtn.classList.contains('active');
            const heartIcon = heartBtn.querySelector('i');

            if (isActive) {
                wishlist = wishlist.filter(w => w.id !== currentPopupId);
                heartBtn.classList.remove('active');
                heartIcon.classList.remove('fa-solid');
                heartIcon.classList.add('fa-regular');
                heartIcon.style.color = '#9ca3af';
            } else {
                const wishlistItem = product ? {
                    id: product.id, name: product.name, images: product.images || productImages[currentPopupId] || [],
                    price: product.offerPrice || product.price || 0, offerPrice: product.offerPrice || product.price || 0,
                    originalPrice: product.originalPrice || product.offerPrice || product.price || 0,
                    weight: product.weight || '0', discountPercent: product.discountPercent || 0,
                    inStock: product.inStock !== false, category: product.category || 'necklaces'
                } : { id: currentPopupId, name: name, images: productImages[currentPopupId] || [], price: 0, offerPrice: 0, originalPrice: 0, weight: '0', discountPercent: 0, inStock: true, category: 'necklaces' };
                
                wishlist.push(wishlistItem);
                heartBtn.classList.add('active');
                heartIcon.classList.remove('fa-regular');
                heartIcon.classList.add('fa-solid');
                heartIcon.style.color = '#ef4444';
            }

            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            updateWishlistUI();
        }

        function refreshPopup(isOutOfStock = false) {
            const inCart = cart[currentPopupId]?.qty || 0;
            const actionsDiv = document.getElementById('popup-actions');
            const priceText = document.getElementById('popup-price').innerText.replace('₹', '').replace(/,/g, '');
            const price = parseInt(priceText);
            const productName = document.getElementById('popup-title').innerText;
            
            if (isOutOfStock) {
                actionsDiv.innerHTML = `<button class="popup-add-to-cart" disabled>Out of Stock</button>`;
            } else if (inCart > 0) {
                actionsDiv.innerHTML = `<div class="popup-qty-control"><button class="popup-qty-btn" onclick="updateCartItem('${currentPopupId}', -1); refreshPopup(false)">−</button><span class="popup-qty-display">${inCart}</span><button class="popup-qty-btn" onclick="updateCartItem('${currentPopupId}', 1); refreshPopup(false)">+</button></div>`;
            } else {
                actionsDiv.innerHTML = `<button class="popup-add-to-cart" onclick="addToCartWithFeedback('${currentPopupId}', '${productName}', ${price}); refreshPopup(false)">Add to Cart</button>`;
            }
        }

        function closePopup() {
            document.getElementById('product-popup').classList.remove('active');
            document.body.style.overflow = '';
            zoomLevel = 1;
            currentImageIndex = 0;
        }

        document.getElementById('product-popup')?.addEventListener('click', (e) => {
            if (e.target.id === 'product-popup') closePopup();
        });
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        
        document.addEventListener('DOMContentLoaded', () => {
            const checkDb = setInterval(() => {
                if (window.db) {
                    clearInterval(checkDb);
                    loadProductsFromFirebase();
                }
            }, 100);
            setTimeout(() => {
                if (firebaseProducts.length === 0) generateFallbackProducts();
            }, 5000);
        });

        // Initialize cart and login functions
window.toggleCart = function() {
    const sidebar = document.getElementById('cart-sidebar');
    if (sidebar) {
        sidebar.classList.toggle('translate-x-full');
    }
};

window.toggleLoginPanel = function() {
    const panel = document.getElementById('login-panel');
    const overlay = document.getElementById('login-panel-overlay');
    if (!panel) {
        window.location.href = 'login.html';
        return;
    }
    const isOpen = panel.classList.contains('translate-x-0');
    if (isOpen) {
        panel.classList.remove('translate-x-0');
        panel.classList.add('translate-x-full');
        if (overlay) overlay.classList.add('hidden');
    } else {
        panel.classList.remove('translate-x-full');
        panel.classList.add('translate-x-0');
        if (overlay) overlay.classList.remove('hidden');
    }
};

window.panelLogin = async function() {
    const email = document.getElementById('panel-email')?.value;
    const password = document.getElementById('panel-password')?.value;
    const errEl = document.getElementById('login-panel-error');
    
    if (!email || !password) {
        if (errEl) {
            errEl.textContent = 'Please enter email and password.';
            errEl.classList.remove('hidden');
        }
        return;
    }
    
    try {
        const { getAuth, signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');
        const auth = getAuth();
        await signInWithEmailAndPassword(auth, email, password);
        // Success - panel will update via auth state listener or reload
        window.location.reload();
    } catch (err) {
        if (errEl) {
            errEl.textContent = 'Login failed: ' + err.message;
            errEl.classList.remove('hidden');
        }
    }
};

window.panelLogout = async function() {
    try {
        const { getAuth, signOut } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');
        await signOut(getAuth());
        window.location.reload();
    } catch (e) {
        console.error('Logout error:', e);
    }
};
    </script>
</body>
</html>