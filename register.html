<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - SKJ Jewellers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --royal-green: #004d40; --gold: #D4AF37; }
        .bg-royal-green { background-color: var(--royal-green); }
        .text-gold { color: var(--gold); }
        .text-royal-green { color: var(--royal-green); }
        .password-strength { height: 4px; border-radius: 2px; transition: all 0.3s; }
        .step { display: none; }
        .step.active { display: block; }
        .otp-input { letter-spacing: 0.5rem; font-size: 1.5rem; text-align: center; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-8">

    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-royal-green mb-1">SKJ</h1>
            <p class="text-gray-500 text-sm">Sai Kiran Jewellers</p>
        </div>

        <!-- Step indicators -->
        <div class="flex items-center justify-center gap-2 mb-6">
            <div id="step-dot-1" class="w-3 h-3 rounded-full bg-royal-green"></div>
            <div class="w-8 h-0.5 bg-gray-300" id="step-line-1"></div>
            <div id="step-dot-2" class="w-3 h-3 rounded-full bg-gray-300"></div>
            <div class="w-8 h-0.5 bg-gray-300" id="step-line-2"></div>
            <div id="step-dot-3" class="w-3 h-3 rounded-full bg-gray-300"></div>
        </div>

        <!-- Step 1: Account Details -->
        <div id="step-1" class="step active">
            <h2 class="text-xl font-semibold mb-1">Create Account</h2>
            <p class="text-gray-500 text-sm mb-5">Fill in your details to get started</p>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Full Name *</label>
                <input type="text" id="fullName" required
                    class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-royal-green"
                    placeholder="Enter your full name">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Email Address *</label>
                <input type="email" id="email" required
                    class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-royal-green"
                    placeholder="Enter your email">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Phone Number *</label>
                <div class="flex gap-2">
                    <span class="flex items-center px-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 text-sm font-medium">+91</span>
                    <input type="tel" id="phone" pattern="[0-9]{10}" required maxlength="10"
                        class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-royal-green"
                        placeholder="10-digit mobile number">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Password *</label>
                <div class="relative">
                    <input type="password" id="password" required
                        class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-royal-green"
                        placeholder="Create a strong password">
                    <button type="button" onclick="togglePassword('password','eyeIcon1')" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-eye" id="eyeIcon1"></i>
                    </button>
                </div>
                <div class="mt-2">
                    <div class="password-strength bg-gray-200 w-full" id="strengthBar"></div>
                    <p class="text-xs text-gray-500 mt-1" id="strengthText">Password strength: Weak</p>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Confirm Password *</label>
                <div class="relative">
                    <input type="password" id="confirmPassword" required
                        class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-royal-green"
                        placeholder="Confirm your password">
                    <button type="button" onclick="togglePassword('confirmPassword','eyeIcon2')" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-eye" id="eyeIcon2"></i>
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <label class="flex items-start">
                    <input type="checkbox" id="terms" required class="mt-1 mr-2">
                    <span class="text-sm text-gray-600">I agree to the <a href="#" class="text-royal-green hover:underline">Terms & Conditions</a> and <a href="#" class="text-royal-green hover:underline">Privacy Policy</a> *</span>
                </label>
            </div>

            <div class="mb-5">
                <label class="flex items-center">
                    <input type="checkbox" id="newsletter" checked class="mr-2">
                    <span class="text-sm text-gray-600">Subscribe to newsletter for exclusive offers</span>
                </label>
            </div>

            <!-- Invisible reCAPTCHA container -->
            <div id="recaptcha-container"></div>

            <button type="button" id="step1Btn" onclick="submitStep1()"
                class="w-full bg-royal-green text-white py-3 rounded-lg font-semibold hover:bg-opacity-90 transition flex items-center justify-center">
                <span>Continue</span>
            </button>
        </div>

        <!-- Step 2: Phone OTP -->
        <div id="step-2" class="step">
            <h2 class="text-xl font-semibold mb-1">Verify Phone</h2>
            <p class="text-gray-500 text-sm mb-5">Enter the 6-digit OTP sent to <span id="phone-display" class="font-medium text-royal-green"></span></p>

            <div class="mb-5">
                <label class="block text-sm font-medium mb-2">OTP *</label>
                <input type="text" id="otpInput" maxlength="6" inputmode="numeric"
                    class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-royal-green otp-input"
                    placeholder="------">
            </div>

            <button type="button" id="verifyOtpBtn" onclick="verifyOtp()"
                class="w-full bg-royal-green text-white py-3 rounded-lg font-semibold hover:bg-opacity-90 transition flex items-center justify-center mb-3">
                <span>Verify OTP</span>
            </button>

            <button type="button" id="resendOtpBtn" onclick="resendOtp()"
                class="w-full border border-royal-green text-royal-green py-3 rounded-lg font-semibold hover:bg-gray-50 transition text-sm">
                Resend OTP
            </button>

            <button type="button" onclick="goBack()"
                class="w-full mt-2 text-gray-500 text-sm hover:text-royal-green transition">
                <i class="fas fa-arrow-left mr-1"></i>Back
            </button>
        </div>

        <!-- Step 3: Email verification sent -->
        <div id="step-3" class="step">
            <div class="text-center py-4">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-envelope-open-text text-2xl text-green-600"></i>
                </div>
                <h2 class="text-xl font-semibold mb-2">Check Your Email</h2>
                <p class="text-gray-500 text-sm mb-4">We've sent a verification link to<br><strong id="email-display" class="text-royal-green"></strong></p>
                <p class="text-gray-400 text-xs mb-6">Click the link in the email to activate your account. After verifying, you can sign in.</p>

                <button type="button" id="resendEmailBtn" onclick="resendVerificationEmail()"
                    class="w-full border border-royal-green text-royal-green py-3 rounded-lg font-semibold hover:bg-gray-50 transition mb-3">
                    Resend Verification Email
                </button>

                <a href="login.html"
                    class="w-full block text-center bg-royal-green text-white py-3 rounded-lg font-semibold hover:bg-opacity-90 transition">
                    Go to Sign In
                </a>
            </div>
        </div>

        <!-- Error / success messages -->
        <div id="errorMessage" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden text-sm"></div>
        <div id="successMessage" class="mt-4 p-3 bg-green-100 text-green-700 rounded-lg hidden text-sm"></div>

        <div class="mt-6 text-center">
            <span class="text-sm text-gray-500">Already a member? <a href="login.html" class="text-royal-green font-medium hover:underline">Sign In</a></span>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        if (!firebase.apps.length) {
            firebase.initializeApp({
                apiKey: "AIzaSyATmseHSU3qimkm6pSCJ_xA1EL3_KiHtXs",
                authDomain: "skj-jewelry-store.firebaseapp.com",
                projectId: "skj-jewelry-store",
                storageBucket: "skj-jewelry-store.firebasestorage.app",
                messagingSenderId: "531463279637",
                appId: "1:531463279637:web:2ab8aaaa80211045252a1c",
                measurementId: "G-0S99YE5NR1"
            });
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        let confirmationResult = null;
        let recaptchaVerifier = null;
        let createdUser = null;
        let formData = {};

        // ── Password strength ──────────────────────────────────────────────
        document.getElementById('password').addEventListener('input', function(e) {
            const password = e.target.value;
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            const colors = ['bg-red-500','bg-orange-500','bg-yellow-500','bg-green-400','bg-green-600'];
            const widths = ['20%','40%','60%','80%','100%'];
            const texts = ['Weak','Fair','Good','Strong','Very Strong'];
            strengthBar.className = `password-strength ${colors[strength-1] || 'bg-gray-200'}`;
            strengthBar.style.width = widths[strength-1] || '0%';
            strengthText.textContent = `Password strength: ${texts[strength-1] || 'Weak'}`;
        });

        window.togglePassword = function(inputId, iconId) {
            const el = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (el.type === 'password') {
                el.type = 'text';
                icon.classList.replace('fa-eye','fa-eye-slash');
            } else {
                el.type = 'password';
                icon.classList.replace('fa-eye-slash','fa-eye');
            }
        };

        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg;
            el.classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function showSuccess(msg) {
            const el = document.getElementById('successMessage');
            el.textContent = msg;
            el.classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function clearMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function setStepIndicator(step) {
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById(`step-dot-${i}`);
                dot.className = i <= step
                    ? 'w-3 h-3 rounded-full bg-royal-green'
                    : 'w-3 h-3 rounded-full bg-gray-300';
            }
        }

        function showStep(n) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${n}`).classList.add('active');
            setStepIndicator(n);
            clearMessages();
        }

        function goBack() { showStep(1); }

        function initRecaptcha() {
            if (recaptchaVerifier) {
                try { recaptchaVerifier.clear(); } catch(e) {}
            }
            recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                size: 'invisible',
                callback: () => {}
            });
        }

        // ── Step 1: Validate form and send OTP ────────────────────────────
        window.submitStep1 = async function() {
            clearMessages();
            const btn = document.getElementById('step1Btn');

            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const terms = document.getElementById('terms').checked;

            if (!fullName) { showError('Please enter your full name.'); return; }
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError('Please enter a valid email address.'); return; }
            if (!/^\d{10}$/.test(phone)) { showError('Please enter a valid 10-digit phone number.'); return; }
            if (password.length < 6) { showError('Password must be at least 6 characters.'); return; }
            if (password !== confirmPassword) { showError('Passwords do not match.'); return; }
            if (!terms) { showError('Please accept the Terms & Conditions.'); return; }

            // Store form data
            formData = {
                fullName, email, phone, password,
                newsletter: document.getElementById('newsletter').checked
            };

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending OTP...';

            try {
                initRecaptcha();
                const phoneNumber = '+91' + phone;
                confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, recaptchaVerifier);

                document.getElementById('phone-display').textContent = '+91 ' + phone;
                showStep(2);
            } catch (err) {
                let msg = 'Failed to send OTP. Please try again.';
                if (err.code === 'auth/invalid-phone-number') msg = 'Invalid phone number.';
                else if (err.code === 'auth/too-many-requests') msg = 'Too many attempts. Please try again later.';
                else if (err.code === 'auth/captcha-check-failed') msg = 'reCAPTCHA failed. Please reload and try again.';
                showError(msg);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Continue</span>';
            }
        };

        // ── Step 2: Verify OTP, create account, send email verification ───
        window.verifyOtp = async function() {
            clearMessages();
            const otp = document.getElementById('otpInput').value.trim();
            if (otp.length !== 6) { showError('Please enter the 6-digit OTP.'); return; }

            const btn = document.getElementById('verifyOtpBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verifying...';

            try {
                // Verify OTP — signs in with phone temporarily
                const phoneCredential = await confirmationResult.confirm(otp);

                // Sign out the phone-auth session immediately (we only needed OTP verification)
                await auth.signOut();

                // Now create the real email/password account
                const userCredential = await auth.createUserWithEmailAndPassword(formData.email, formData.password);
                createdUser = userCredential.user;

                // Set display name
                await createdUser.updateProfile({ displayName: formData.fullName });

                // Send email verification
                await createdUser.sendEmailVerification();

                // Save user to Firestore (inactive until email verified — login.html enforces this)
                await db.collection('users').doc(createdUser.uid).set({
                    uid: createdUser.uid,
                    email: formData.email,
                    displayName: formData.fullName,
                    phone: formData.phone,
                    role: 'customer',
                    newsletter: formData.newsletter,
                    phoneVerified: true,
                    emailVerified: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    preferences: { notifications: true, newsletter: formData.newsletter }
                });

                // Sign out immediately — user must verify email before logging in
                await auth.signOut();

                document.getElementById('email-display').textContent = formData.email;
                showStep(3);

            } catch (err) {
                let msg = 'Verification failed. Please try again.';
                if (err.code === 'auth/invalid-verification-code') msg = 'Incorrect OTP. Please check and try again.';
                else if (err.code === 'auth/code-expired') msg = 'OTP has expired. Please request a new one.';
                else if (err.code === 'auth/email-already-in-use') msg = 'An account with this email already exists.';
                else if (err.code === 'auth/weak-password') msg = 'Password is too weak.';
                showError(msg);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Verify OTP</span>';
            }
        };

        // ── Resend OTP ─────────────────────────────────────────────────────
        window.resendOtp = async function() {
            clearMessages();
            const btn = document.getElementById('resendOtpBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            try {
                initRecaptcha();
                const phoneNumber = '+91' + formData.phone;
                confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, recaptchaVerifier);
                showSuccess('New OTP sent successfully.');
            } catch(err) {
                showError('Failed to resend OTP. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Resend OTP';
            }
        };

        // ── Resend email verification ──────────────────────────────────────
        window.resendVerificationEmail = async function() {
            clearMessages();
            const btn = document.getElementById('resendEmailBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            try {
                // Sign in temporarily to resend verification
                const userCredential = await auth.signInWithEmailAndPassword(formData.email, formData.password);
                await userCredential.user.sendEmailVerification();
                await auth.signOut();
                showSuccess('Verification email resent. Check your inbox.');
            } catch(err) {
                showError('Could not resend email. Please go to Sign In and use "Forgot Password" if needed.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Resend Verification Email';
            }
        };
    </script>
</body>
</html>
